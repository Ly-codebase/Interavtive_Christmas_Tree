// Simplified COI Service Worker to ensure same-origin registration
(function() {
  if (self.crossOriginIsolated !== true) {
    const swPath = './coi-serviceworker.js'; // The script itself
    
    // Attempt to register the Service Worker
    self.addEventListener('load', () => {
      if (self.navigator.serviceWorker) {
        if (self.navigator.serviceWorker.controller) {
          // If already registered, refresh to activate COEP/COOP
          if (self.location.origin === self.location.origin) {
            self.location.reload(); 
            return;
          }
        }
        
        // Register the Service Worker (using the same-origin script)
        self.navigator.serviceWorker.register(swPath).then(() => {
          console.log('COI Service Worker registered. Please refresh.');
          // Force reload to apply COEP/COOP headers
          if (!self.crossOriginIsolated) {
             self.location.reload(); 
          }
        }).catch(error => {
          console.error('COOP/COEP Service Worker failed to register:', error);
        });
      }
    });
  }
})();
